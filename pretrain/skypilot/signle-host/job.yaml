num_nodes: 4

run: |
  conda activate ant-pretrain
  cd ~/sky_workdir

  echo "=== Environment Variables ==="
  env | grep -E "(SKYPILOT|RAY|TPU|JAX)" | sort
  echo "============================="

  export TPU_WORKER_HOSTNAMES=$(echo "${SKYPILOT_NODE_IPS}" | tr ' ' ',' | tr '\n' ',' | sed 's/,$//')
  export TPU_WORKER_ID=$SKYPILOT_NODE_RANK

  echo "TPU_WORKER_ID: ${TPU_WORKER_ID}"
  echo "TPU_WORKER_HOSTNAMES: ${TPU_WORKER_HOSTNAMES}"


  python3 -m src.MaxText.train \
    src/MaxText/configs/base.yml \
    model_name='llama3-8b' \
    base_output_directory=gs://test-ant-pretrain-output \
    dataset_path=gs://test-ant-pretrain-dataset \
    run_name=test-llama3-8b-on-skypilot-tpuv7-2x2x1 \
    per_device_batch_size=4 \
    steps=10 \
    enable_checkpointing=true \
    checkpoint_period=500 \
    log_period=50
