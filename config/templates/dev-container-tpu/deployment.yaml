apiVersion: apps/v1
kind: Deployment
metadata:
  name: "sgl-tpu-{{.UserName}}"
  labels:
    app: sgl-tpu
    developer: "{{.UserName}}"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sgl-tpu
      developer: "{{.UserName}}"
  template:
    metadata:
      labels:
        app: sgl-tpu
        developer: "{{.UserName}}"
    spec:
      nodeSelector:
        cloud.google.com/gke-tpu-accelerator: {{.TPUType}}
        cloud.google.com/gke-tpu-topology: {{.TPUTopology}}
      containers:
      - name: dev-container-tpu
        image: ghcr.io/zhengkezhou1/sgl-jax-action/dev-container-tpu:sha-600456e
        securityContext:
          privileged: true
        resources:
          requests:
            cpu: "16"
            memory: "64Gi"
            google.com/tpu: {{.TPUCount}}
          limits:
            cpu: "32"
            memory: "64Gi"
            google.com/tpu: {{.TPUCount}}
        ports:
        - name: ssh
          containerPort: 22
        lifecycle:
          postStart:
            exec:
              command:
              - /bin/bash
              - -c
              - |
                cat > /etc/profile.d/tpu-env.sh << TPUEOF
                # TPU Environment Variables (auto-generated from container env)
                export TPU_ACCELERATOR_TYPE="${TPU_ACCELERATOR_TYPE}"
                export TPU_CHIPS_PER_HOST_BOUNDS="${TPU_CHIPS_PER_HOST_BOUNDS}"
                export TPU_HOST_BOUNDS="${TPU_HOST_BOUNDS}"
                export TPU_RUNTIME_METRICS_PORTS="${TPU_RUNTIME_METRICS_PORTS}"
                export TPU_SKIP_MDS_QUERY="${TPU_SKIP_MDS_QUERY}"
                export TPU_TOPOLOGY_ALT="${TPU_TOPOLOGY_ALT}"
                export TPU_TOPOLOGY_WRAP="${TPU_TOPOLOGY_WRAP}"
                export TPU_TOPOLOGY="${TPU_TOPOLOGY}"
                export TPU_WORKER_HOSTNAMES="${TPU_WORKER_HOSTNAMES}"
                export TPU_WORKER_ID="${TPU_WORKER_ID}"
                export VBAR_CONTROL_SERVICE_URL="${VBAR_CONTROL_SERVICE_URL}"
                export JAX_COMPILATION_CACHE_DIR="${JAX_COMPILATION_CACHE_DIR:-/tmp/jit_cache}"
                TPUEOF

                # Auto-load TPU environment for all login shells
                if ! grep -q 'source /etc/profile.d/tpu-env.sh' /root/.bashrc 2>/dev/null; then
                  echo '# Auto-load TPU environment variables' >> /root/.bashrc
                  echo 'source /etc/profile.d/tpu-env.sh' >> /root/.bashrc
                fi
        livenessProbe:
          tcpSocket:
            port: 22
          initialDelaySeconds: 30
          periodSeconds: 10
        volumeMounts:
        - name: ssh-key
          mountPath: /tmp/ssh-keys
          readOnly: true
      volumes:
      - name: ssh-key
        configMap:
          name: sgl-ssh-key-{{.UserName}}
          defaultMode: 0644